{% extends "customer_base.html" %}
{% load static %}
{% block content %}
<!-- 菜單類別 -->
<div class="container-fluid row">
    <div class="col-md-2">
        <div class="col-md-12 position-sticky shadow-lg p-3 mb-5 bg-body rounded" style="top: 60px;">
            <div class="list-group">
                <a class="list-group-item list-group-item-action text-dark d-flex justify-content-between align-items-start"
                    href="/">全部餐點
                </a>
                {% for list in count_list %}
                <a class="list-group-item list-group-item-action text-dark d-flex justify-content-between align-items-start"
                    id="category_number{{list.meals_category}}"
                    name="category_number{{list.meals_category}}"
                    value="{{list.meals_category}}"
                    href="/?cn={{list.meals_category}}">
                    {{list.category_name}}
                    <span class="badge bg-primary rounded-pill">{{list.total}}</span>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>


    <div class="col-md-10">
        <div class="container-fluid ">
            <span class="fs-2 text-secondary">優惠專區</span>
            <hr>
            <div class="justify-content-center d-flex">
                <div id="carouselExampleControls" class="carousel slide container-fluid" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem;">
                                        <img src="{% static 'image/steak.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">牛排</h5>
                                            <p class="card-text">使用澳洲牛肉</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem;">
                                        <img src="{% static  'image/pork.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">豬排</h5>
                                            <p class="card-text">使用台灣山地野生黑豬</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem;">
                                        <img src="{% static 'image/goat.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">羊排</h5>
                                            <p class="card-text">使用台灣野生山羌</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem;">
                                        <img src="{% static 'image/chicken.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">雞排排</h5>
                                            <p class="card-text">使用玉山山脈上放山雞</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item ">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem; ">
                                        <img src="{% static 'image/steak.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">牛排</h5>
                                            <p class="card-text">使用澳洲牛肉</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem;">
                                        <img src="{% static 'image/pork.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">豬排</h5>
                                            <p class="card-text">使用台灣山地野生黑豬</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem;">
                                        <img src="{% static 'image/goat.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">羊排</h5>
                                            <p class="card-text">使用台灣野生山羌</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem; ">
                                        <img src="{% static 'image/chicken.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">雞排排</h5>
                                            <p class="card-text">使用玉山山脈上放山雞</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item ">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem; ">
                                        <img src="{% static 'image/steak.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">牛排</h5>
                                            <p class="card-text">使用澳洲牛肉</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem; ">
                                        <img src="{% static 'image/goat.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">羊排</h5>
                                            <p class="card-text">使用台灣野生山羌</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem; ">
                                        <img src="{% static 'image/pork.jpg' %}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">豬排</h5>
                                            <p class="card-text">使用台灣山地野生黑豬</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card" style="width: 15rem;">
                                        <img src="{% static 'image/chicken.jpg'%}" class="card-img-top" alt="..."
                                            style="width:200px;height:200px;">
                                        <div class="card-body">
                                            <h5 class="card-title">雞排排</h5>
                                            <p class="card-text">使用玉山山脈上放山雞</p>
                                            <a href="/" class="btn btn-primary">前往訂餐</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="rounded shadow-lg p-3 mb-3 mt-3 bg-body">
            <div class="mb-3 row d-flex justify-content-center">
                <span class="fs-2 text-secondary">所有餐點</span>
                <hr>
                {% for meals in total_meals%}
                <div class="card mx-2 mt-3 mb-2" style="width: 15rem";>
                    <form action="/add_to_cart/" method="POST">
                        {% csrf_token %}
                        <div class="mt-3 mb-3 justify-content-center d-flex position-relative">
                             <div class="mt-2 mb-2 position-absolute bottom-0 end-0 bg-info text-dark rounded">
                                {{meals.meals_discount_values}} % OFF
                            </div>
                            <img src="{%static 'media/menu/'%}{{meals.meals_owner}}/{{meals.meals_image}}"
                                class="card-img-top" style="height: 120px;width: 120px;">
                        </div>
                        <div class="card-body">
                            <div class="input-group mt-2">
                                <span class="input-group-text">名稱</span>
                                <input type="text" class="form-control" id="meals_name{{meals.meals_number}}"
                                        name="meals_name{{meals.meals_number}}" value='{{meals.meals_name}}' readonly>
                            </div>
                            <div class="input-group mt-2">
                                <span class="input-group-text">價格</span>
                                <input type="text" class="form-control" id="meals_prices{{meals.meals_number}}"
                                    name="meals_prices{{meals.meals_number}}" value='{{meals.meals_price}}' readonly>
                            </div>

                            <div class="input-group mt-2">
                                <span class="input-group-text">描述</span>
                                <textarea class="form-control" name="meals_meals_description{{meals.meals_number}}" readonly>{{meals.meals_description}}</textarea>
                            </div>
                            <div class="input-group mt-2 mb-3">
                                <span class="input-group-text">數量</span>
                                <input type="number" class="form-control" id="meals_quantity{{meals.meals_number}}" name="meals_quantity{{ meals.meals_number }}"
                                value="{% if request.method == 'POST' %}{% with meals_quantity_key='meals_quantity'|add:meals.meals_number %}{{ request.POST.meals_quantity_key }}{% endwith %}{% else %}0{% endif %}">
                            </div>
                            <!-- 添加隐藏的输入字段 -->
                            <input type="hidden" name="meals_id" value="{{meals.meals_number}}">
                            <input type="hidden" name="meals_name" value="{{meals.meals_name}}">
                            <button type="submit" class="btn btn-primary">加入購物車</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // 获取所有加入购物车按钮
    var addToCartButtons = document.querySelectorAll('.btn-primary');

    // 循环为每个按钮添加点击事件监听器
    addToCartButtons.forEach(function(button) {
        button.addEventListener('click', function(event) {
            // 阻止表单默认提交行为
            event.preventDefault();

            // 获取当前按钮所在的表单元素
            var form = button.closest('form');

            // 获取表单中的 meal_id、meals_quantity 及 meals_name
            var mealId = form.querySelector('[name="meals_id"]').value;
            var mealQuantity = form.querySelector('[name="meals_quantity' + mealId + '"]').value;
            var mealName = form.querySelector('[name="meals_name"]').value;

            // 创建一个对象，存储 meal_id、数量和用户IP地址
            var cartItem = {
                meal_id: mealId,
                quantity: mealQuantity,
                user_ip: '{{ request.META.REMOTE_ADDR }}'  // 获取用户IP地址，这里使用模板语法，请确保在模板中使用该代码时能够正确渲染
            };

            // 获取当前cookie中的购物车数据
            var existingCartData = JSON.parse(getCookie('cart_data') || '[]');

            // 判断购物车中是否已经存在相同的meal_id
            var existingCartItemIndex = existingCartData.findIndex(function(item) {
                return item.meal_id === mealId;
            });

            // 如果购物车中已经存在相同的meal_id，则修改该项的数量和用户IP地址
            if (existingCartItemIndex !== -1) {
                existingCartData[existingCartItemIndex].quantity = mealQuantity;
                existingCartData[existingCartItemIndex].user_ip = '{{ request.META.REMOTE_ADDR }}';
            } else {
                // 否则将新的购物车项添加到购物车数据中
                existingCartData.push(cartItem);
            }

            // 将更新后的购物车数据存储到cookie中
            setCookie('cart_data', JSON.stringify(existingCartData), 1);  // 这里的1表示cookie的过期时间，单位为天
        });
    });

    // 函数：设置cookie
    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    // 函数：获取cookie
    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }
</script>



{% endblock content %}